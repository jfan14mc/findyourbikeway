<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="style.css" rel="stylesheet" type="text/css">
    <style>
        #map { height: 400px; width: 100%; }
        #controls { margin-top: 20px; }
        input, button { margin: 5px; }
        #directions { margin-top: 20px; }
        #avoidanceAreas { margin-top: 10px; }
        #avoidanceList { margin-top: 10px; }
    </style>
</head>

<body>
    <header>
        <h1>Bike Route Enhancer</h1>
        <p>Improving bike routes through community feedback</p>
    </header>

    <nav class="navigation">
        <ul>
           <li><a href="index.html"> Home </a></li>
           <li><a href="about.html"> About </a> </li>
           <li><a href="report.html"> Contribute </a> </li>
           <li><a href="leaflet.html"> Map </a> </li>
       </ul>
    </nav>    
    <div id="map"></div>
    <div id="controls">
        <input type="text" id="fromAddress" placeholder="From Address" value="32 vassar street, cambridge, ma">
        <input type="text" id="toAddress" placeholder="To Address" value="392 harvard st, cambridge, ma">
        <button onclick="calculateRoute()">Calculate Route</button>
    </div>
    <div id="avoidanceAreas">
        <h3>Avoidance Areas</h3>
        <p>Click and drag on the map to create avoidance areas.</p>
        <button onclick="clearAvoidanceAreas()">Clear Avoidance Areas</button>
    </div>
    <div id="avoidanceList">
        <h3>List of Avoidance Areas</h3>
        <ul id="avoidanceListItems"></ul>
    </div>
    <div id="directions"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script>
        let map, routeLayer, avoidanceLayer;
        const apiKey = '5b3ce3597851110001cf62483ee3405e20b844b4b5e0390a3f701f55'; // Replace with your API key
        let avoidanceAreas = [];

        // Pre-defined list of avoidance areas :)
        const predefinedAvoidanceAreas = [
            [[42.3615, -71.0982], [42.3682, -71.1126]] // Central Square, Cambridge
        ];

        function initMap() {
            map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const { latitude, longitude } = position.coords;
                    map.setView([latitude, longitude], 13);
                });
            }

            avoidanceLayer = L.layerGroup().addTo(map);
            initDrawing();
            addPredefinedAvoidanceAreas();
            updateAvoidanceList();
        }

        function initDrawing() {
            let isDrawing = false;
            let startLatLng, endLatLng;

            map.on('mousedown', (e) => {
                isDrawing = true;
                startLatLng = e.latlng;
            });

            map.on('mousemove', (e) => {
                if (isDrawing) {
                    endLatLng = e.latlng;
                    drawTempRectangle(startLatLng, endLatLng);
                }
            });

            map.on('mouseup', () => {
                if (isDrawing) {
                    isDrawing = false;
                    if (startLatLng && endLatLng) {
                        addAvoidanceArea(startLatLng, endLatLng);
                        updateAvoidanceList();
                    }
                }
            });
        }

        function drawTempRectangle(start, end) {
            if (window.tempRectangle) {
                map.removeLayer(window.tempRectangle);
            }
            window.tempRectangle = L.rectangle([start, end], {color: 'red', weight: 1}).addTo(map);
        }

        function addAvoidanceArea(start, end) {
            const rectangle = L.rectangle([start, end], {color: 'red', fillOpacity: 0.3}).addTo(avoidanceLayer);
            avoidanceAreas.push([[start.lat, start.lng], [end.lat, end.lng]]);
        }

        function clearAvoidanceAreas() {
            avoidanceLayer.clearLayers();
            avoidanceAreas = [];
            updateAvoidanceList();
        }

        function addPredefinedAvoidanceAreas() {
            predefinedAvoidanceAreas.forEach(area => {
                addAvoidanceArea(L.latLng(area[0]), L.latLng(area[1]));
            });
        }

        function updateAvoidanceList() {
            const listElement = document.getElementById('avoidanceListItems');
            listElement.innerHTML = '';
            avoidanceAreas.forEach((area, index) => {
                const li = document.createElement('li');
                li.textContent = `Area ${index + 1}: [${area[0][0].toFixed(4)}, ${area[0][1].toFixed(4)}], [${area[1][0].toFixed(4)}, ${area[1][1].toFixed(4)}]`;
                listElement.appendChild(li);
            });
        }

        async function calculateRoute() {
            const fromAddress = document.getElementById('fromAddress').value;
            const toAddress = document.getElementById('toAddress').value;

            const fromCoords = await geocode(fromAddress);
            const toCoords = await geocode(toAddress);

            if (!fromCoords || !toCoords) {
                alert('Unable to geocode one or both addresses');
                return;
            }

            // Prepare avoidance areas for the API request
            const avoid_polygons = avoidanceAreas.map(area => {
                return {
                    "type": "Polygon",
                    "coordinates": [[
                        [area[0][1], area[0][0]],
                        [area[1][1], area[0][0]],
                        [area[1][1], area[1][0]],
                        [area[0][1], area[1][0]],
                        [area[0][1], area[0][0]]
                    ]]
                };
            });

            const body = {
                "coordinates": [[fromCoords.lon, fromCoords.lat], [toCoords.lon, toCoords.lat]],
                "options": {
                    "avoid_polygons": {
                        "type": "MultiPolygon",
                        "coordinates": avoid_polygons.map(p => p.coordinates)
                    }
                }
            };

            const url = `https://api.openrouteservice.org/v2/directions/cycling-regular/geojson`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': apiKey
                    },
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                displayRoute(data);
                displayDirections(data);
            } catch (error) {
                console.error('Error calculating route:', error);
                alert('Error calculating route');
            }
        }

        async function geocode(address) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.length > 0) {
                    return { lat: data[0].lat, lon: data[0].lon };
                }
            } catch (error) {
                console.error('Error geocoding:', error);
            }
            return null;
        }

        function displayRoute(routeData) {
            if (routeLayer) {
                map.removeLayer(routeLayer);
            }

            const coordinates = routeData.features[0].geometry.coordinates;
            const latLngs = coordinates.map(coord => [coord[1], coord[0]]);

            routeLayer = L.polyline(latLngs, { color: 'blue' }).addTo(map);
            map.fitBounds(routeLayer.getBounds());
        }

        function displayDirections(routeData) {
            const steps = routeData.features[0].properties.segments[0].steps;
            const directionsDiv = document.getElementById('directions');
            directionsDiv.innerHTML = '<h3>Directions:</h3>';
            const ol = document.createElement('ol');
            steps.forEach(step => {
                const li = document.createElement('li');
                li.textContent = step.instruction;
                ol.appendChild(li);
            });
            directionsDiv.appendChild(ol);
        }

        window.onload = initMap;
    </script>
</body>
</html>

<!-- 
Developer Instructions:

To maintain this page with new avoidance areas:

1. Locate the `predefinedAvoidanceAreas` array in the JavaScript code.
2. Add new avoidance areas to this array using the following format:
   [[latitude1, longitude1], [latitude2, longitude2]]
   
   Example:
   [[40.7128, -74.0060], [40.7228, -74.0160]]

3. Each pair of coordinates represents the top-left and bottom-right corners of a rectangular avoidance area.
4. You can find coordinates for specific locations using online tools like Google Maps or OpenStreetMap.
5. After adding new areas, test the page to ensure they appear correctly on the map.

Remember to keep the array format consistent and use valid coordinate pairs for each avoidance area.
-->
